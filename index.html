<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>

		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">

		<style type="text/css">
			html, body, #map-canvas {
				height: 100%;
				margin: 10px;
				padding: 10px
			}

			.showorhide {
				display: none;
			}
		</style>
		
		<script src="js/jquery-1.4.1.min.js" type="text/javascript"></script>
		<script src="js/jquery-1.9.1.js" type="text/javascript"></script>
		
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
		<script type="text/javascript" src="js/country_names.js"></script>

		<script type="text/javascript" src="http://platform.linkedin.com/in.js">
api_key: 752f7e023f5cet
authorize: true
credentials_cookie: true
credentials_cookie_crc: true
onLoad: onLinkedInLoad
scope: w_messages rw_company_admin r_emailaddress r_network r_basicprofile rw_groups r_fullprofile rw_nus r_contactinfo
Secret_Key:8hEIlinuKm6NElKu
OAuth_User_Token:d85dac7f-2152-464c-a4cd-fce0090c2643
OAuth_User_Secret:7af07505-1776-4b78-8f63-c8cdd8ddb54b
		</script>

		<!-- Google Map intialization-->
		<script>
			// Note: This example requires that you consent to location sharing when
			// prompted by your browser. If you see a blank space instead of the map, this
			// is probably because you have denied permission for location sharing.

			var map;

			var mFinalData = [];
			var m_country_name_arr = [];

			var boxList = [];

			var cityList = [['Pune', 18.5204303, 73.8567437, 1], ['Mumbai', 19.0759837, 72.87765589999999, 2], ['Delhi', 28.635308, 77.22496, 3], ['Kolkata', 22.572646, 88.36389500000001, 4], ['Chennai', 13.0597049, 80.2252278, 5]];

			var position = getLocationCoordinates("Pune,India");
			console.log("Position : "+ position);	

			function initialize(connections, total_countrywise_connections, country_name_arr) {

				mFinalData = total_countrywise_connections;
				m_country_name_arr = country_name_arr;

				var mapOptions = {
					scaleControl : true,
					// Pune - 18.5203, 73.8567
					// India - 20.593684, 78.96288
					center : new google.maps.LatLng(20.593684, 78.96288),
					zoom : 2
				};

				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

				// getCitywiseConnctions("Delhi", mFinalData["in"]);		
				console.log("total_countrywise_connections : "+total_countrywise_connections.length);
				
				for (var i = 0; i < total_countrywise_connections.length; i++) {
				
					var mCountryName = m_country_name_arr[i].toUpperCase();
					var mFullCountryName = getCountryName(mCountryName);

					
					var total_cities = [];
					total_cities = getCitiesName(connections, country_name_arr);
					console.log(" "+mFullCountryName+" is total cities is : "+total_cities[m_country_name_arr[i]].length);

					// console.log("Total Connections of " + mFullCountryName);
					
					var address = mFullCountryName;
					var geocoder = new google.maps.Geocoder();

					geocoder.geocode({
						'address' : address
					}, function(results, status) {

						if (status == google.maps.GeocoderStatus.OK) {

							var mFullCountryName = getCountryName((results[0].address_components[0].short_name).toUpperCase());

							// console.log(mFullCountryName + " mLattitude : " + results[0].geometry.location.lat() + " mLongitude : " + results[0].geometry.location.lng());

							var position = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());

							var marker = new google.maps.Marker({
								map : map,
								position : position,

							});

							var infowindow = new google.maps.InfoWindow();

							var mTempUsersArray_CountryWise = mFinalData[(results[0].address_components[0].short_name).toLowerCase()];

							infowindow.setContent('<a href="#" id="test_' + (results[0].address_components[0].short_name).toLowerCase() + '"><b> ' + mFullCountryName + ' = ' + mTempUsersArray_CountryWise.length + '</b></a>');

							google.maps.event.addListener(marker, 'click', function() {
								infowindow.open(map, marker);
							});

							google.maps.event.addDomListener(infowindow, 'domready', function() {
								$('#test_in').click(function() {

									map.setZoom(4);
									// This will trigger a zoom_changed on the map
									map.setCenter(new google.maps.LatLng(20.593684, 78.96288));

									/*console.log("City List : "+cityList.length);

									 var position = new google.maps.LatLng(18.463056, 74.57888899999999);

									 var marker = new google.maps.Marker({
									 map : map,
									 position : position,

									 });

									 var infowindow = new google.maps.InfoWindow();

									 infowindow.setContent('<b> Daund, Pune </b>');
									 google.maps.event.addListener(marker, 'click', function() {
									 infowindow.open(map, marker);
									 });*/

									var marker, i;
									/*var infowindow = new google.maps.InfoWindow({
									 disableAutoPan : true,
									 isHidden : false,
									 pixelOffset : new google.maps.Size(-10, -10),
									 closeBoxURL : "",
									 pane : "mapPane",
									 enableEventPropagation : true
									 });*/

									var infowindow = new google.maps.InfoWindow();

									for (var i = 0; i < cityList.length; i++) {
										marker = new google.maps.Marker({
											position : new google.maps.LatLng(cityList[i][1], cityList[i][2]),
											map : map,
											id : i,
											title : cityList[i][0]
										});

										var boxText = document.createElement("div");
										boxText.id = i;
										boxText.className = "labelText" + i;
										boxText.innerHTML = cityList[i][0];
										boxList.push(boxText);

										google.maps.event.addListener(marker, 'click', (function(marker, i) {
											var contentString = '<div id="infoWindow">' + '<div id="bodyContent">' + '<p>' + "This location is:<br>" + marker.title + '</p>' + '</div>' + '</div>';

											return function() {
												infowindow.setContent(boxList[this.id]);
												infowindow.open(map, marker);
											};
										})(marker, i));
										//end add marker listener

										google.maps.event.addDomListener(boxList[i], 'click', (function(marker, i) {
											return function() {
												alert('clicked ' + cityList[i][0])
											}
										})(marker, i));

									} //endfor

								});

							});

						} else
							console.log("Geocode failed, status: " + status);

					});

				}

			}
			
			function getCitiesName(connections, country_name_arr) {

	var final_city_array = [];

	for ( j = 0; j < country_name_arr.length; ++j) {

		var city_list = [];

		for (id in connections) {

			if (connections[id].id == 'private' || connections[id].location.country.code == 'private')
				continue;

			if (connections[id].location.country.code == country_name_arr[j]) {

				//Remove the area word from the location name
				var str = connections[id].location.name, re = /Area/g, result = [], match, last_idx = 0;

				while ( match = re.exec(str)) {
					result.push(str.slice(last_idx, re.lastIndex - match[0].length), match[0]);
					last_idx = re.lastIndex;
				}
				result.push(str.slice(last_idx));
				//End for Remove the area word from the location name

				//Remove comma from the string and separate city
				str1 = result[0];
				result2 = str1.split(",");
				//End Remove comma from the string and separate city

				// console.log(result2[0]);
				if (city_list.indexOf(result2[0]) == -1) {
					city_list.push(result2[0]);
				}
			}
		}
		final_city_array.push(city_list);
	}

	for ( index1 = 0; index1 < country_name_arr.length; ++index1) {
		for ( k = 0; k < final_city_array.length; ++k) {
			if (index1 == k) {
				final_city_array[country_name_arr[index1]] = final_city_array[k];
				delete final_city_array[k];
			}

		}
	}

	// console.log(final_city_array);
	return final_city_array;
}

		
function getCitywiseConnctions(city_name, total_country_connections) {

	var member;
	var members_arr = [];

	for (var i = 0; i < total_country_connections.length; i++) {
		member = total_country_connections[i];

		// members_arr.push(member);
		// console.log("Name : "+member.fname+" "+member.lname+" : "+member.location_name);

		var position = member.location_name.search(city_name);
		if (position != -1) {
			members_arr.push(member);
			console.log("Name : " + member.fname + " " + member.lname + " : " + member.location_name);
		} else {
			// NOP
		}

	};
	console.log("members_arr : " + members_arr.length);
	return members_arr;
}

		</script>
		<!-- End of Google Map intialization-->

		<script type="text/javascript" src="js/country_names.js"></script>

		<!-- Linkedin Stuff -->
		<script type="text/javascript">
			function onLinkedInLoad() {
				IN.Event.on(IN, "auth", onLinkedInAuth);
				var div = document.getElementByClass("showorhide");
				div.style.visibility = "visible";
			}

			function onLinkedInAuth() {
				// IN.API.Profile("me").result(ShowProfileData);

				IN.API.Profile("me").fields("firstName", "lastName", "industry", "location:(name)", "picture-url", "headline", "summary", "num-connections", "public-profile-url", "distance", "positions", "email-address", "educations", "date-of-birth", "threeCurrentPositions").result(displayProfiles).error(displayProfilesErrors);
			}

			//var foo = null;

			function displayProfiles(profiles) {
				document.getElementById('div1').style.display = 'block';
				member = profiles.values[0];

				document.getElementById("lblName").innerHTML = member.firstName + " " + member.lastName + "<br/> Location is " + member.location.name;
				document.getElementById("imgProfile").src = member.pictureUrl;
				document.getElementById("lblEmail").innerHTML = member.emailAddress;
				document.getElementById("lblProfile").innerHTML = member.publicProfileUrl;
				document.getElementById("lblconnection").innerHTML = member.numConnections;
				foo = member.numConnections;
			}

			function onLinkedInLogout() {
				//setConnections({}, {total:0});
				try {
					IN.User.logout();
				} catch (err) {
					console.log(err);
				}
				setTimeout("goToHome()", 10000);
			}

			function goToHome() {
				location.href = "index.html";
			}

			function onLinkedInconnection() {
				// here, we pass the fields as individual string parameters
				IN.API.Connections("me").fields("id", "firstName", "lastName", "pictureUrl", "publicProfileUrl", "threeCurrentPositions", "location:(name,country:(code))")
				//.params({"count" : foo})
				.result(function(result, metadata) {
					// var data = JSON.parse(JSON.stringify(result));
					// console.log(JSON.stringify(result));
					// console.log(data["values"][0]["firstName"]);
					// console.log(data["values"][0]["lastName"]);

					//console.log("Connection Results : "+data);
					setConnections(result.values, metadata);
				});

			}

			function arraySearch(arr, val) {
				for (var i = 0; i < arr.length; i++) {
					if (arr[i] == val) {
						return i;
					} else {
						return false;
					}
				}
			}

			function setConnections(connections, metadata) {
				
				var country_name_arr = [];

				for (id in connections) {

					if (connections[id].id == 'private' || connections[id].location.country.code == 'private' || connections[id].location.country.code == 'oo')
						continue;

					if (country_name_arr.indexOf(connections[id].location.country.code) == -1) {
						country_name_arr.push(connections[id].location.country.code);
					}
				}

				var total_countrywise_connections = [];
				for ( index = 0; index < country_name_arr.length; ++index) {

					var user_array = [];
					for (id in connections) {

						if (connections[id].id == 'private' || connections[id].location.country.code == 'private' || 
								connections[id].location.country.code == 'oo')
							continue;

						if (connections[id].location.country.code == country_name_arr[index]) {

							var temp = {};
							var temp_array = [];

							var user_info = {
								fname : connections[id].firstName,
								lname : connections[id].lastName,
								id : connections[id].id,
								location_name: connections[id].location.name,
								location : connections[id].location.country.code,
								profile_url : connections[id].publicProfileUrl
							};
							
							user_array.push(user_info);
						}

					}

					// add users data..
					total_countrywise_connections.push(user_array);
				}

				for ( index = 0; index < country_name_arr.length; ++index) {
					for ( i = 0; i < total_countrywise_connections.length; ++i) {
						if (index == i) {

							//total_countrywise_connections["in"] = users array having country is India.. Noted
							total_countrywise_connections[country_name_arr[index]] = total_countrywise_connections[i];

							// free up memory
							delete total_countrywise_connections[i];
						}

					}
				}

				// console.log(total_countrywise_connections);
				// console.log(total_countrywise_connections.length + " " + country_name_arr.length);

				for ( index = 0; index < country_name_arr.length; ++index) {
					// console.log("Country : " + country_name_arr[index]);
				}

				initialize(connections, total_countrywise_connections, country_name_arr);
				
				// // get cities from country data 
				// getCitiesName(connections, country_name_arr);
			}			

		</script>
		<!-- End of Linkedin Stuff -->

		<title>VSPLC Linkedin Prototype</title>
	</head>
	<body>
		<p>
			This example demonstrates how to retrieve a user's connections.  It also uses the LinkedIn auth events (load, login,
			<input type="button" name="search1" value="Logout" onclick="onLinkedInLogout()">
			) to control behavior.
		</p>

		<script type="text/javascript">
			var assert = require('assert'), countrynames = require('./');

			assert.equal(countrynames.getCode('French Guiana'), 'GF');
			assert.equal(countrynames.getName('BF'), 'BURKINA FASO');
			assert.equal(countrynames.getCode('Iran'), countrynames.getCode('IRAN, ISLAMIC REPUBLIC OF'));
			assert.equal(countrynames.getCode(countrynames.getName('IO')), 'IO');
			assert.ok(countrynames.getAllCodes() instanceof Array);
			assert.ok(countrynames.getAllNames() instanceof Array);

			console.log('Passed successfully.');
		</script>

		<script type="IN/Login"></script>
		<input type="button" name="search1" value="Search LinkedIn!" onclick="search()">
		<input type="button" name="con" value="Connection" onclick="onLinkedInconnection()">

		<div id="div1" style="display:none">
			<table>
				<b>Get Linkedin LoggedIn User Details</b>
				<tr>
					<td>Name:</td>
					<td><label id="lblName"></label></td>
				</tr>
				<tr>
					<td>Email:</td>
					<td><label id="lblEmail"></label></td>
				</tr>
				<tr>
					<td>Profile Url:</td>
					<td><label id="lblProfile"></label></td>
				</tr>
				<tr>
					<td>Profile Image:</td>
					<td><img id="imgProfile"></label></td>
				</tr>
				<tr>
					<td>Connection:</td>
					<td><label id="lblconnection"></label></td>
				</tr>
			</table>
		</div>

		<div id="connectionsDiv">
			<p>
				Current User's Connections:
			</p>
			<div id="connectionsdata"></div>
			<div id="connections"></div>
		</div>

		<div id="map-canvas"></div>

	</body>
</html>