<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>

		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">

		<style type="text/css">
			html, body, #map-canvas {
				height: 100%;
				margin: 10px;
				padding: 10px
			}

			.showorhide {
				display: none;
			}
		</style>

		<!--<script src="js/jquery-1.4.1.min.js" type="text/javascript"></script>
		<script src="js/jquery-1.9.1.js" type="text/javascript"></script>-->
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>

		<script src="http://maps.googleapis.com/maps/api/js?v=3.exp"></script>
		<script type="text/javascript" src="js/country_names.js"></script>

		<script type="text/javascript" src="http://platform.linkedin.com/in.js">
api_key: 752f7e023f5cet
authorize: true
credentials_cookie: true
credentials_cookie_crc: true
onLoad: onLinkedInLoad
scope: w_messages rw_company_admin r_emailaddress r_network r_basicprofile rw_groups r_fullprofile rw_nus r_contactinfo
Secret_Key:8hEIlinuKm6NElKu
OAuth_User_Token:d85dac7f-2152-464c-a4cd-fce0090c2643
OAuth_User_Secret:7af07505-1776-4b78-8f63-c8cdd8ddb54b
		</script>

		<!-- Google Map intialization-->
		<script>
			// Note: This example requires that you consent to location sharing when
			// prompted by your browser. If you see a blank space instead of the map, this
			// is probably because you have denied permission for location sharing.

			var map;

			var mFinalData = [];
			var m_country_name_arr = [];

			var boxList = [];

			var cityList = [['Pune', 18.5204303, 73.8567437, 1], ['Mumbai', 19.0759837, 72.87765589999999, 2], ['Delhi', 28.635308, 77.22496, 3], ['Kolkata', 22.572646, 88.36389500000001, 4], ['Chennai', 13.0597049, 80.2252278, 5]];

			var markers = [];
			var infowindows = [];

			function initialize(connections, total_countrywise_connections, country_name_arr) {

				mFinalData = total_countrywise_connections;
				m_country_name_arr = country_name_arr;

				// var position = getLocationCoordinate("Delhi,India");
				// console.log("Position : " + position.lat + " " + position.lng);

				var mapOptions = {
					scaleControl : true,
					// Pune - 18.5203, 73.8567
					// India - 20.593684, 78.96288
					center : new google.maps.LatLng(20.593684, 78.96288),
					zoom : 2
				};

				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

				// getCitywiseConnctions("Delhi", mFinalData["in"]);
				// console.log("total_countrywise_connections : " + total_countrywise_connections.length);

				var locations = [];

				// we currently fixed it to 10 countries instead of "total_countrywise_connections"
				for (var i = 0; i < total_countrywise_connections.length; i++) {

					var mCountryName = m_country_name_arr[i].toUpperCase();
					var mFullCountryName = getCountryName(mCountryName);

					var total_cities = [];
					total_cities = getCitiesName(connections, country_name_arr);
					// console.log(" " + mFullCountryName + " is total cities is : " + total_cities[m_country_name_arr[i]].length);

					var address = mFullCountryName;

					var position = getLocationCoordinate(address);

					if (position != null) {
						var location = {
							location_name : m_country_name_arr[i],
							latitude : position.lat,
							longitude : position.lng,
						};
						locations.push(location);
					} else {
						console.log("Geocode failed");
					};

				}

				setMarkers(map, locations, m_country_name_arr, mFinalData, connections);
			}

			function setMarkers(map, locations, m_country_name_arr, mFinalData, connections) {
				
				var marker, i;
				for ( i = 0; i < locations.length; i++) {
					
					var location = locations[i];
					
					var loc_name = location.location_name;
					var lat = location.latitude;
					var lng = location.longitude;
					
					latlngset = new google.maps.LatLng(lat, lng);
					var marker = new google.maps.Marker({
						map : map,
						title : loc_name,
						position : latlngset
					});

					// map.setCenter(marker.getPosition())

					var mTempUsersArray_CountryWise = mFinalData[m_country_name_arr[i]];
					
					var mCountryName = m_country_name_arr[i].toUpperCase();
					var mFullCountryName = getCountryName(mCountryName);
					
					var content = '<div id="test_' + m_country_name_arr[i] + '"><b> ' + mFullCountryName + ' = ' + mTempUsersArray_CountryWise.length + '</b></div>';
					var infowindow = new google.maps.InfoWindow();
					
					google.maps.event.addListener(marker, 'click', (function(marker, content, infowindow) {
						return function() {
							infowindow.setContent(content);
							infowindow.open(map, marker);
						};
					})(marker, content, infowindow));

					google.maps.event.addDomListener(infowindow, 'domready',(function(marker) {
						
						return function() {
							var id = marker.title;						
							// console.log("infoWindow : "+marker.title);
							getOnItemOnclick(connections, mFinalData, marker.title);
						};
							
					})(marker)); 
				}
			}

			function setCityWiseMarkers(map, locations, id, cities) {
				
				var city_marker;
				for ( i = 0; i < locations.length; i++) {
					
					var location = locations[i];
					
					var city_name = location.location_name;					
					var city_lat = location.latitude;
					var city_lng = location.longitude;
					var city = location.city_name;					
					
					city_position = new google.maps.LatLng(city_lat, city_lng);
					
					var city_marker = new google.maps.Marker({
						map : map,
						title : city_name,
						position : city_position
					});

					console.log("id : "+id);
					var position = getLocationCoordinate(id);
					console.log("position : "+position.lat+" "+position.lng);

					// map.setCenter();

					var city_connections = getCitywiseConnctions(city, mFinalData[id]);

					var info_content = '<div id="test_pune"><b>'+ city_marker.title  +'= </b>'+city_connections.length+'</div>';
					var city_infowindow = new google.maps.InfoWindow();
					
					google.maps.event.addListener(city_marker, 'click', (function(city_marker, info_content, city_infowindow) {
						
						return function() {
							city_infowindow.setContent(info_content);
							city_infowindow.open(map, city_marker);
						};
						
					})(city_marker, info_content, city_infowindow));

					/*google.maps.event.addDomListener(infowindow, 'domready',(function(marker) {
						
						return function() {
							var id = marker.title;						
							// var infoWindow = infowindow.getContent();
							console.log("infoWindow : "+marker.title);
							getOnItemOnclick(connections, marker.title);
							};
							
					})(marker)); */
					
				}
			}

			function getOnItemOnclick(connections, mFinalData, id){
				// $("#test_"+id).click(function() {
						// alert(id+' : clicked');
				// });
				var locations = [];				
				var cities = [];				
				cities = getCityNamesFromCountry(connections, id);
				
				var mCountryName = id.toUpperCase();
				var mFullCountryName = getCountryName(mCountryName);

				var address;
				for (var i=0; i < cities.length; i++) {
				  address = cities[i]+","+mFullCountryName;
				  var position = getLocationCoordinate(address);
				  
				  if (position != null) {
						var location = {
							city_name : cities[i],
							location_name : address,
							latitude : position.lat,
							longitude : position.lng,
						};

						locations.push(location);
					} else {
						console.log("Geocode failed");
					}
				}
			
				setCityWiseMarkers(map, locations, id, cities);
			}				

			function getCitiesName(connections, country_name_arr) {

				var final_city_array = [];
				
				for ( j = 0; j < country_name_arr.length; ++j) {
					var city_list = [];
					for (id in connections) {

						if (connections[id].id == 'private' || connections[id].location.country.code == 'private')
							continue;

						if (connections[id].location.country.code == country_name_arr[j]) {

							//Remove the area word from the location name
							var str = connections[id].location.name, re = /Area/g, result = [], match, last_idx = 0;

							while ( match = re.exec(str)) {
								result.push(str.slice(last_idx, re.lastIndex - match[0].length), match[0]);
								last_idx = re.lastIndex;
							}
							result.push(str.slice(last_idx));
							//End for Remove the area word from the location name

							//Remove comma from the string and separate city
							str1 = result[0];
							result2 = str1.split(",");
							//End Remove comma from the string and separate city

							// console.log(result2[0]);
							if (city_list.indexOf(result2[0]) == -1) {
								city_list.push(result2[0]);
							}
						}
					}
					final_city_array.push(city_list);
				}

				for ( index1 = 0; index1 < country_name_arr.length; ++index1) {
					for ( k = 0; k < final_city_array.length; ++k) {
						if (index1 == k) {
							final_city_array[country_name_arr[index1]] = final_city_array[k];
							delete final_city_array[k];
						}

					}
				}
				return final_city_array;
			}

			function getCityNamesFromCountry(connections, country_name) {

					var city_list = [];

					for (id in connections) {

						if (connections[id].id == 'private' || connections[id].location.country.code == 'private')
							continue;

						if (connections[id].location.country.code == country_name) {

							//Remove the area word from the location name
							var str = connections[id].location.name, re = /Area/g, result = [], match, last_idx = 0;

							while ( match = re.exec(str)) {
								result.push(str.slice(last_idx, re.lastIndex - match[0].length), match[0]);
								last_idx = re.lastIndex;
							}
							result.push(str.slice(last_idx));
							//End for Remove the area word from the location name

							//Remove comma from the string and separate city
							str1 = result[0];
							result2 = str1.split(",");
							//End Remove comma from the string and separate city

							if (city_list.indexOf(result2[0]) == -1) {
								city_list.push(result2[0]);
							}
						}
					}
				
				return city_list;
			}

			function getCitywiseConnctions(city_name, total_country_connections) {

				var member;
				var members_arr = [];

				for (var i = 0; i < total_country_connections.length; i++) {
					member = total_country_connections[i];

					var position = member.location_name.search(city_name);
					if (position != -1) {
						members_arr.push(member);
					} else {
						// NOP
					}

				};
				return members_arr;
			}

		</script>
		<!-- End of Google Map intialization-->

		<script type="text/javascript" src="js/country_names.js"></script>

		<!-- Linkedin Stuff -->
		<script type="text/javascript">
			function onLinkedInLoad() {
				IN.Event.on(IN, "auth", onLinkedInAuth);
				var div = document.getElementByClass("showorhide");
				div.style.visibility = "visible";
			}

			function onLinkedInAuth() {
				// IN.API.Profile("me").result(ShowProfileData);

				IN.API.Profile("me").fields("firstName", "lastName", "industry", "location:(name)", "picture-url", "headline", "summary", "num-connections", "public-profile-url", "distance", "positions", "email-address", "educations", "date-of-birth", "threeCurrentPositions").result(displayProfiles).error(displayProfilesErrors);
			}

			//var foo = null;

			function displayProfiles(profiles) {
				document.getElementById('div1').style.display = 'block';
				member = profiles.values[0];

				document.getElementById("lblName").innerHTML = member.firstName + " " + member.lastName + "<br/> Location is " + member.location.name;
				document.getElementById("imgProfile").src = member.pictureUrl;
				document.getElementById("lblEmail").innerHTML = member.emailAddress;
				document.getElementById("lblProfile").innerHTML = member.publicProfileUrl;
				document.getElementById("lblconnection").innerHTML = member.numConnections;
				foo = member.numConnections;
			}

			function onLinkedInLogout() {
				//setConnections({}, {total:0});
				try {
					IN.User.logout();
				} catch (err) {
					console.log(err);
				}
				setTimeout("goToHome()", 10000);
			}

			function goToHome() {
				location.href = "index.html";
			}

			function onLinkedInconnection() {
				// here, we pass the fields as individual string parameters
				IN.API.Connections("me").fields("id", "firstName", "lastName", "pictureUrl", "publicProfileUrl", "threeCurrentPositions", "location:(name,country:(code))")
				//.params({"count" : foo})
				.result(function(result, metadata) {
					// var data = JSON.parse(JSON.stringify(result));
					// console.log(JSON.stringify(result));
					// console.log(data["values"][0]["firstName"]);
					// console.log(data["values"][0]["lastName"]);

					//console.log("Connection Results : "+data);
					setConnections(result.values, metadata);
				});

			}

			function arraySearch(arr, val) {
				for (var i = 0; i < arr.length; i++) {
					if (arr[i] == val) {
						return i;
					} else {
						return false;
					}
				}
			}

			function setConnections(connections, metadata) {

				var country_name_arr = [];

				for (id in connections) {
					
					if (connections[id].id == 'private' || connections[id].location.country.code == 'private' || connections[id].location.country.code == 'oo')
						continue;

					if (country_name_arr.indexOf(connections[id].location.country.code) == -1) {
						country_name_arr.push(connections[id].location.country.code);
					}
				}

				var total_countrywise_connections = [];
				for ( index = 0; index < country_name_arr.length; ++index) {

					var user_array = [];
					for (id in connections) {

						if (connections[id].id == 'private' || connections[id].location.country.code == 'private' || connections[id].location.country.code == 'oo')
							continue;

						if (connections[id].location.country.code == country_name_arr[index]) {

							var temp = {};
							var temp_array = [];

							var user_info = {
								fname : connections[id].firstName,
								lname : connections[id].lastName,
								id : connections[id].id,
								location_name : connections[id].location.name,
								location : connections[id].location.country.code,
								profile_url : connections[id].publicProfileUrl
							};

							
							user_array.push(user_info);
						}

					}
					
					console.log(user_array);
					// add users data..
					total_countrywise_connections.push(user_array);
				}

				for ( index = 0; index < country_name_arr.length; ++index) {
					for ( i = 0; i < total_countrywise_connections.length; ++i) {
						if (index == i) {

							//total_countrywise_connections["in"] = users array having country is India.. Noted
							total_countrywise_connections[country_name_arr[index]] = total_countrywise_connections[i];

							// free up memory
							delete total_countrywise_connections[i];
						}

					}
				}
				initialize(connections, total_countrywise_connections, country_name_arr);
			}

		</script>
		<!-- End of Linkedin Stuff -->

		<title>VSPLC Linkedin Prototype</title>
	</head>
	<body>
		<p>
			This example demonstrates how to retrieve a user's connections.  It also uses the LinkedIn auth events (load, login,
			<input type="button" name="search1" value="Logout" onclick="onLinkedInLogout()">
			) to control behavior.
		</p>

		<script type="text/javascript">
			var assert = require('assert'), countrynames = require('./');

			assert.equal(countrynames.getCode('French Guiana'), 'GF');
			assert.equal(countrynames.getName('BF'), 'BURKINA FASO');
			assert.equal(countrynames.getCode('Iran'), countrynames.getCode('IRAN, ISLAMIC REPUBLIC OF'));
			assert.equal(countrynames.getCode(countrynames.getName('IO')), 'IO');
			assert.ok(countrynames.getAllCodes() instanceof Array);
			assert.ok(countrynames.getAllNames() instanceof Array);

			console.log('Passed successfully.');
		</script>

		<script type="IN/Login"></script>
		<input type="button" name="search1" value="Search LinkedIn!" onclick="search()">
		<input type="button" name="con" value="Connection" onclick="onLinkedInconnection()">

		<div id="div1" style="display:none">
			<table>
				<b>Get Linkedin LoggedIn User Details</b>
				<tr>
					<td>Name:</td>
					<td><label id="lblName"></label></td>
				</tr>
				<tr>
					<td>Email:</td>
					<td><label id="lblEmail"></label></td>
				</tr>
				<tr>
					<td>Profile Url:</td>
					<td><label id="lblProfile"></label></td>
				</tr>
				<tr>
					<td>Profile Image:</td>
					<td><img id="imgProfile"></label></td>
				</tr>
				<tr>
					<td>Connection:</td>
					<td><label id="lblconnection"></label></td>
				</tr>
			</table>
		</div>

		<div id="connectionsDiv">
			<p>
				Current User's Connections:
			</p>
			<div id="connectionsdata"></div>
			<div id="connections"></div>
		</div>

		<div id="map-canvas"></div>

	</body>
</html>